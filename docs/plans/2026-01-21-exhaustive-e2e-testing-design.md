# Exhaustive E2E Testing Design

## Goal

Refactor `syn-gen/test_e2e.py` to perform exhaustive position-level verification that CRISPResso correctly detects every edit and sequencing error generated by syn-gen.

## Current State

- Tests compare aggregate counts (total edited vs unedited reads)
- Uses tolerance ranges (5-15%) for "close enough" matching
- No verification of individual edit positions or types

## Target State

- Strict position-level matching: exact position, size, and count
- Every allele sequence verified between syn-gen and CRISPResso
- Clear error reporting for debugging failures

## Design

### Syn-gen Changes

Add new function `write_alleles_tsv()` in `syn_gen.py`:

```python
def write_alleles_tsv(reads: list[EditedRead], filepath: str) -> None:
    """
    Write per-allele aggregated edit info matching CRISPResso format.
    Groups reads by sequence, aggregates edit metadata.
    """
```

**Output file:** `{prefix}_alleles.tsv`

**Columns (CRISPResso-compatible):**

| Column | Description |
|--------|-------------|
| `#Reads` | Count of reads with this allele |
| `Aligned_Sequence` | The actual nucleotide sequence |
| `all_deletion_positions` | List of deletion positions, e.g., `[85, 86, 87]` |
| `all_deletion_sizes` | List of deletion sizes, e.g., `[3]` |
| `all_insertion_positions` | List of insertion positions |
| `all_insertion_sizes` | List of insertion sizes |
| `all_substitution_positions` | List of substitution positions |
| `all_substitution_values` | List of substitution values, e.g., `['C>T', 'A>G']` |

**Logic:**
1. Group `EditedRead` objects by `read.seq`
2. For each unique sequence:
   - Count occurrences
   - Collect all edit positions/sizes
   - Combine intentional edits and sequencing errors for substitutions
   - Format as Python lists
3. Write TSV with CRISPResso-compatible columns

**Called from `generate_synthetic_data()`:**
```python
alleles_path = f'{output_prefix}_alleles.tsv'
write_alleles_tsv(reads, alleles_path)
```

### Test Changes

Add comparison function in `test_e2e.py`:

```python
def compare_alleles(syngen_alleles_path: str, crispresso_alleles_path: str) -> list[str]:
    """
    Compare syn-gen ground truth against CRISPResso output.
    Returns list of discrepancies (empty = pass).
    """
```

**Comparison logic:**
1. Parse both files into comparable structures
2. Match alleles by `Aligned_Sequence`
3. For each matched allele: verify `#Reads` and all position/size lists match exactly
4. Report any missing alleles or mismatched edits

**Test structure:**
- `TestNHEJEndToEnd` - deletions and insertions
- `TestBaseEditingEndToEnd` - substitutions (CBE/ABE)
- `TestPrimeEditingEndToEnd` - complex edits

**Each test:**
1. Generate synthetic data with `generate_synthetic_data()`
2. Run CRISPResso with `--write_detailed_allele_table`
3. Call `compare_alleles()` to verify exact match
4. Assert no discrepancies

### Error Reporting

**Discrepancy types:**
1. **Missing allele**: Sequence in syn-gen not found in CRISPResso
2. **Extra allele**: Sequence in CRISPResso not in syn-gen ground truth
3. **Count mismatch**: Same sequence, different `#Reads`
4. **Edit mismatch**: Same sequence, but positions/sizes differ

**Example failure output:**
```
MISMATCH for allele ACGT...TCG (15 reads):
  deletion_positions: expected [85, 86, 87], got [84, 85, 86]
  deletion_sizes: expected [3], got [3]

MISSING allele GCTA...AAC (3 reads) - not found in CRISPResso output

EXTRA allele TTAG...GGC (2 reads) - unexpected in CRISPResso output
```

### Edit Type Mapping

| Syn-gen Edit Type | CRISPResso Column |
|-------------------|-------------------|
| NHEJ deletions | `all_deletion_positions` |
| NHEJ insertions | `all_insertion_positions` |
| Base editing (CBE/ABE) | `all_substitution_positions` |
| Sequencing errors | `all_substitution_positions` |
| Prime editing | Varies by outcome type |

Note: Base editing substitutions and sequencing errors both appear in `all_substitution_positions` since CRISPResso cannot distinguish between them.

### Matching Rules

- **Strict matching**: Exact position and size must match
- **Allele matching**: By nucleotide sequence
- **Count matching**: Exact `#Reads` match required
- **No tolerance**: Any deviation is a test failure

## Files Modified

1. `syn-gen/syn_gen.py` - Add `write_alleles_tsv()` function
2. `syn-gen/test_e2e.py` - Refactor tests to use strict comparison

## Testing

Run locally before CI:
```bash
cd syn-gen && pytest test_e2e.py -v
```
